// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Profile table - synced with Supabase auth.users
model Profile {
  id                   String   @id @db.Uuid // References auth.users(id)
  email                String?
  fullName             String?  @map("full_name")
  avatarUrl            String?  @map("avatar_url")
  theme                String   @default("ember")
  businessType         String?  @map("business_type")
  onboardingCompleted  Boolean  @default(false) @map("onboarding_completed")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @default(now()) @map("updated_at")

  // Team relations
  ownedTeams      Team[]           @relation("TeamOwner")
  teamMemberships TeamMember[]
  sentInvitations TeamInvitation[] @relation("InvitationSender")

  // Twilio / SMS
  phone           UserPhone?
  smsMessages     SMSMessage[]
  conversations   Conversation[]

  @@map("profiles")
}

// ============================================================================
// TEAMS - Multi-user CRM sharing with roles
// ============================================================================

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String   @map("owner_id") @db.Uuid
  owner       Profile  @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  members     TeamMember[]
  invitations TeamInvitation[]
  contacts    Contact[]
  deals       Deal[]
  tasks       Task[]
  properties  Property[]
  activities  Activity[]

  @@index([ownerId])
  @@map("teams")
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String   @map("team_id")
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id") @db.Uuid
  user      Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("member") // owner, admin, member, viewer
  joinedAt  DateTime @default(now()) @map("joined_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([teamId, userId])
  @@index([userId])
  @@map("team_members")
}

model TeamInvitation {
  id           String    @id @default(cuid())
  teamId       String    @map("team_id")
  team         Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  email        String    // Email of the invited person
  role         String    @default("member") // admin, member, viewer
  invitedById  String    @map("invited_by_id") @db.Uuid
  invitedBy    Profile   @relation("InvitationSender", fields: [invitedById], references: [id], onDelete: Cascade)
  token        String    @unique // Unique invite token for accepting
  status       String    @default("pending") // pending, accepted, declined, expired
  expiresAt    DateTime  @map("expires_at")
  acceptedAt   DateTime? @map("accepted_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([teamId, status])
  @@index([email, status])
  @@index([token])
  @@map("team_invitations")
}

model Contact {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id") @db.Uuid // Owner of this contact
  teamId     String?  @map("team_id") // Team this contact belongs to (for shared CRMs)
  team       Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  name       String
  email      String?
  phone      String?
  type       String   @default("lead") // lead, client, agent, vendor
  tags       String[] @default([]) // buyer, seller, renter
  source     String? // zillow, website, referral, social, cold_call, open_house, other
  notes      String?
  isFavorite Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  properties   Property[]
  deals        Deal[]
  tasks        Task[]
  activities   Activity[]
  inboxThreads InboxThread[]
  noteRecords  Note[]

  @@index([teamId])
}

model Activity {
  id          String   @id @default(cuid())
  userId      String?  @map("user_id") @db.Uuid // Owner of this activity
  teamId      String?  @map("team_id")
  team        Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  type        String // call, email, meeting, note, task_completed, deal_update
  title       String
  description String?
  metadata    String? // JSON string for extra data (email subject, call duration, etc.)
  createdAt   DateTime @default(now())

  // Relations
  contactId  String?
  contact    Contact?  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  dealId     String?
  deal       Deal?     @relation(fields: [dealId], references: [id], onDelete: SetNull)
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  @@index([teamId])
}

model Document {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id") @db.Uuid // Owner of this document
  name      String
  type      String // contract, disclosure, inspection, photo, other
  url       String // file path or URL
  size      Int? // file size in bytes
  createdAt DateTime @default(now())

  // Relations
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  dealId     String?
  deal       Deal?     @relation(fields: [dealId], references: [id], onDelete: SetNull)
}

model Property {
  id          String   @id @default(cuid())
  userId      String?  @map("user_id") @db.Uuid // Owner of this property record
  teamId      String?  @map("team_id")
  team        Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  address     String
  city        String
  state       String?
  zipCode     String?
  price       Float
  status      String   @default("pre_listing") // pre_listing, listed, under_contract, sold, off_market
  bedrooms    Int?
  bathrooms   Float?
  sqft        Float?
  description String?
  imageUrl    String?
  isFavorite  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  ownerId    String?
  owner      Contact?   @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  deals      Deal[]
  tasks      Task[]
  activities Activity[]
  documents  Document[]

  @@index([teamId])
}

model Deal {
  id                String    @id @default(cuid())
  userId            String?   @map("user_id") @db.Uuid // Owner of this deal
  teamId            String?   @map("team_id")
  team              Team?     @relation(fields: [teamId], references: [id], onDelete: SetNull)
  title             String
  stage             String    @default("new_lead") // new_lead, qualified, showing, offer, negotiation, closed
  value             Float?
  expectedCloseDate DateTime?
  notes             String?
  isFavorite        Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  contactId  String?
  contact    Contact?   @relation(fields: [contactId], references: [id], onDelete: SetNull)
  propertyId String?
  property   Property?  @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  tasks      Task[]
  activities Activity[]
  documents  Document[]

  @@index([teamId])
}

model Task {
  id          String    @id @default(cuid())
  userId      String?   @map("user_id") @db.Uuid // Owner of this task
  teamId      String?   @map("team_id")
  team        Team?     @relation(fields: [teamId], references: [id], onDelete: SetNull)
  title       String
  description String?
  dueDate     DateTime?
  priority    String    @default("medium") // low, medium, high
  completed   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  contactId  String?
  contact    Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  dealId     String?
  deal       Deal?     @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([teamId])
}

model EmailAccount {
  id           String   @id @default(cuid())
  userId       String   @map("user_id") @db.Uuid // Supabase auth user ID
  provider     String // gmail, outlook
  email        String // The connected email address
  accessToken  String   @map("access_token") // OAuth access token
  refreshToken String   @map("refresh_token") // OAuth refresh token
  expiresAt    DateTime @map("expires_at") // Token expiration
  isDefault    Boolean  @default(false) @map("is_default")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([userId, email])
  @@index([userId])
}

// ============================================================================
// INBOX - Unified communication hub (email, SMS, calls)
// ============================================================================

model InboxThread {
  id                 String    @id @default(cuid())
  contactId          String?   @map("contact_id")
  contact            Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  teamId             String?   @map("team_id") // For future team inbox support
  assignedUserId     String?   @map("assigned_user_id") @db.Uuid
  status             String    @default("open") // open, archived, snoozed
  snoozedUntil       DateTime? @map("snoozed_until")
  lastMessageAt      DateTime  @map("last_message_at")
  lastMessagePreview String?   @map("last_message_preview")
  // For unknown senders (no contact match)
  unknownEmail       String?   @map("unknown_email")
  unknownPhone       String?   @map("unknown_phone")
  unknownName        String?   @map("unknown_name")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  messages     InboxMessage[]
  participants InboxParticipant[]

  @@index([assignedUserId, status, lastMessageAt(sort: Desc)])
  @@index([teamId, status, lastMessageAt(sort: Desc)])
  @@index([contactId])
  @@map("inbox_threads")
}

model InboxMessage {
  id                String      @id @default(cuid())
  threadId          String      @map("thread_id")
  thread            InboxThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  channel           String // email, sms, call
  direction         String // inbound, outbound
  status            String      @default("sent") // sent, delivered, failed, missed, completed, voicemail
  occurredAt        DateTime    @map("occurred_at")
  subject           String? // email only
  fromAddress       String      @map("from_address")
  toAddress         String      @map("to_address")
  bodyText          String?     @map("body_text")
  bodyHtml          String?     @map("body_html")
  providerMessageId String?     @map("provider_message_id")
  metadata          Json? // Extra provider-specific data
  createdByUserId   String?     @map("created_by_user_id") @db.Uuid
  createdAt         DateTime    @default(now()) @map("created_at")

  @@index([threadId, occurredAt(sort: Desc)])
  @@index([providerMessageId])
  @@map("inbox_messages")
}

model InboxParticipant {
  threadId   String      @map("thread_id")
  thread     InboxThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  userId     String      @map("user_id") @db.Uuid
  lastReadAt DateTime?   @map("last_read_at")
  createdAt  DateTime    @default(now()) @map("created_at")

  @@id([threadId, userId])
  @@index([userId, lastReadAt])
  @@map("inbox_participants")
}

// ============================================================================
// REFERRALS - Industry-agnostic referral exchange with embedded conversation
// ============================================================================

model Referral {
  id              String   @id @default(cuid())
  createdByUserId String   @map("created_by_user_id") @db.Uuid
  orgId           String?  @map("org_id") // For future team/org support
  visibility      String   @default("public") // org | network | public
  status          String   @default("open") // open | claimed | assigned | closed
  category        String // e.g., "real_estate", "plumbing", "finance", "legal"
  title           String
  description     String?
  locationText    String?  @map("location_text")
  valueEstimate   Float?   @map("value_estimate")
  currency        String?  @default("USD")
  metadata        Json?    @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  participants ReferralParticipant[]
  messages     ReferralMessage[]
  claims       ReferralClaim[]

  @@index([visibility, status, updatedAt(sort: Desc)])
  @@index([createdByUserId, status])
  @@index([category, status])
  @@map("referrals")
}

model ReferralParticipant {
  referralId String   @map("referral_id")
  referral   Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  userId     String   @map("user_id") @db.Uuid
  role       String // creator | claimant | collaborator | observer
  joinedAt   DateTime @default(now()) @map("joined_at")

  @@id([referralId, userId])
  @@index([userId, role])
  @@map("referral_participants")
}

model ReferralMessage {
  id              String   @id @default(cuid())
  referralId      String   @map("referral_id")
  referral        Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  createdByUserId String   @map("created_by_user_id") @db.Uuid
  messageType     String   @default("comment") @map("message_type") // comment | system | private
  bodyText        String?  @map("body_text")
  bodyHtml        String?  @map("body_html")
  visibility      String   @default("public") // public | participants_only
  metadata        Json?    @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([referralId, createdAt(sort: Asc)])
  @@index([createdByUserId])
  @@map("referral_messages")
}

model ReferralClaim {
  id              String   @id @default(cuid())
  referralId      String   @map("referral_id")
  referral        Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  claimantUserId  String   @map("claimant_user_id") @db.Uuid
  message         String? // Optional message with claim request
  status          String   @default("requested") // requested | accepted | rejected
  createdAt       DateTime @default(now()) @map("created_at")
  resolvedAt      DateTime? @map("resolved_at")

  @@index([referralId, status])
  @@index([claimantUserId, status])
  @@map("referral_claims")
}

// ============================================================================
// HONEYCOMB - Marketing Suite (Campaigns, Creatives, Segments)
// ============================================================================

model HoneycombCampaign {
  id          String    @id @default(cuid())
  userId      String    @map("user_id") @db.Uuid // Owner of this campaign
  name        String
  description String?
  status      String    @default("draft") // draft | active | paused | completed | archived
  objective   String?   // awareness | traffic | engagement | leads | sales
  budget      Float?
  dailyBudget Float?    @map("daily_budget")
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  
  // Performance metrics (updated via integrations, null until connected)
  impressions Int       @default(0)
  clicks      Int       @default(0)
  conversions Int       @default(0)
  spend       Float     @default(0)
  
  metadata    Json?     @default("{}")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  creatives CampaignCreative[]
  segments  CampaignSegment[]

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("honeycomb_campaigns")
}

model HoneycombCreative {
  id           String   @id @default(cuid())
  userId       String   @map("user_id") @db.Uuid // Owner of this creative
  name         String
  description  String?
  type         String   @default("image") // image | video | carousel | html
  format       String?  // 1080x1080, 1200x628, 1080x1920, 300x250, 728x90
  status       String   @default("draft") // draft | approved | rejected | archived
  fileUrl      String?  @map("file_url")
  thumbnailUrl String?  @map("thumbnail_url")
  fileSize     Int?     @map("file_size") // bytes
  headline     String?
  bodyText     String?  @map("body_text")
  ctaText      String?  @map("cta_text")
  ctaUrl       String?  @map("cta_url")
  metadata     Json?    @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  campaigns CampaignCreative[]

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("honeycomb_creatives")
}

model HoneycombSegment {
  id          String   @id @default(cuid())
  userId      String   @map("user_id") @db.Uuid // Owner of this segment
  name        String
  description String?
  type        String   @default("custom") // saved | custom | lookalike
  
  // Audience size estimate (null until calculated)
  size        Int?
  
  // Targeting criteria stored as JSON
  criteria    Json     @default("{}")
  
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  campaigns CampaignSegment[]

  @@index([userId, type])
  @@index([userId, createdAt(sort: Desc)])
  @@map("honeycomb_segments")
}

// Join table: Campaign <-> Creative (many-to-many)
model CampaignCreative {
  campaignId String            @map("campaign_id")
  campaign   HoneycombCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creativeId String            @map("creative_id")
  creative   HoneycombCreative @relation(fields: [creativeId], references: [id], onDelete: Cascade)
  addedAt    DateTime          @default(now()) @map("added_at")

  @@id([campaignId, creativeId])
  @@index([creativeId])
  @@map("honeycomb_campaign_creatives")
}

// Join table: Campaign <-> Segment (many-to-many)
model CampaignSegment {
  campaignId String            @map("campaign_id")
  campaign   HoneycombCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  segmentId  String            @map("segment_id")
  segment    HoneycombSegment  @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  addedAt    DateTime          @default(now()) @map("added_at")

  @@id([campaignId, segmentId])
  @@index([segmentId])
  @@map("honeycomb_campaign_segments")
}

// Chat Studio - AI-powered chat experiences
model HoneycombChatBot {
  id                String   @id @default(cuid())
  userId            String   @map("user_id") @db.Uuid // Owner of this chatbot
  name              String
  description       String?
  status            String   @default("draft") // draft | active | paused
  conversationCount Int      @default(0) @map("conversation_count")
  
  // Configuration
  welcomeMessage    String?  @map("welcome_message")
  systemPrompt      String?  @map("system_prompt")
  
  metadata          Json?    @default("{}")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("honeycomb_chat_bots")
}

// Publishers - Ad network integrations
model HoneycombPublisher {
  id         String   @id @default(cuid())
  userId     String   @map("user_id") @db.Uuid // Owner of this publisher connection
  name       String
  type       String   @default("ad_network") // ad_network | direct | programmatic
  status     String   @default("pending") // connected | pending | disconnected
  logoUrl    String?  @map("logo_url")
  
  // Performance metrics
  placements  Int     @default(0)
  impressions Int     @default(0)
  revenue     Float   @default(0)
  
  // Connection details
  apiKey      String? @map("api_key")
  externalId  String? @map("external_id")
  
  metadata    Json?   @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("honeycomb_publishers")
}

// ============================================================================
// LAM - Large Action Model (AI Action Runtime)
// ============================================================================

// Tracks each LAM execution run
model LamRun {
  id           String      @id @default(cuid())
  userId       String      @map("user_id") @db.Uuid
  message      String      // Original user message
  planJson     Json        @map("plan_json") // Full ActionPlan JSON
  status       String      @default("pending") // pending | executing | completed | failed | approval_required
  resultJson   Json?       @map("result_json") // ExecutionResult JSON
  verifyJson   Json?       @map("verify_json") // VerificationResult JSON
  userSummary  String?     @map("user_summary") // Plain language summary
  createdAt    DateTime    @default(now()) @map("created_at")
  completedAt  DateTime?   @map("completed_at")

  // Relations
  actions              LamAction[]
  idempotencyKeys      LamIdempotencyKey[]
  changeLogs           LamChangeLog[]
  smsMessages          SMSMessage[]
  conversationMessages ConversationMessage[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@map("lam_runs")
}

// Individual actions within a run
model LamAction {
  id             String   @id @default(cuid())
  runId          String   @map("run_id")
  run            LamRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  actionId       String   @map("action_id") // UUID from action schema
  actionType     String   @map("action_type") // lead.create, deal.update, etc.
  idempotencyKey String   @map("idempotency_key")
  riskTier       Int      @default(0) @map("risk_tier") // 0, 1, or 2
  payloadJson    Json     @map("payload_json")
  status         String   @default("pending") // pending | executed | failed | skipped | approval_required
  resultJson     Json?    @map("result_json")
  createdAt      DateTime @default(now()) @map("created_at")
  executedAt     DateTime? @map("executed_at")

  @@index([runId])
  @@index([actionType])
  @@index([idempotencyKey])
  @@map("lam_actions")
}

// Idempotency tracking to prevent duplicate operations
model LamIdempotencyKey {
  id        String   @id @default(cuid())
  key       String   @unique // The idempotency key
  runId     String   @map("run_id")
  run       LamRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  resultJson Json?   @map("result_json") // Cached result for idempotent replay
  createdAt DateTime @default(now()) @map("created_at")

  @@index([key])
  @@map("lam_idempotency_keys")
}

// Change log for undo functionality
model LamChangeLog {
  id          String   @id @default(cuid())
  runId       String   @map("run_id")
  run         LamRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  actionId    String   @map("action_id") // Reference to the action that caused change
  entityType  String   @map("entity_type") // Contact, Deal, Task, Activity
  entityId    String   @map("entity_id") // ID of the affected entity
  operation   String   // create | update | delete
  beforeJson  Json?    @map("before_json") // State before change (null for create)
  afterJson   Json?    @map("after_json") // State after change (null for delete)
  undone      Boolean  @default(false) // Whether this change has been undone
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([runId])
  @@index([entityType, entityId])
  @@index([undone])
  @@map("lam_change_logs")
}

// Note model for LAM (Activity already exists but this is more specific)
model Note {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id") @db.Uuid
  body      String
  contactId String?  @map("contact_id")
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  dealId    String?  @map("deal_id")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([contactId])
  @@index([dealId])
  @@map("notes")
}

// ============================================================================
// META ADS INTEGRATION - Facebook/Instagram Ads
// ============================================================================

// Connected Meta Ad Accounts
model MetaAdAccount {
  id              String    @id @default(cuid())
  userId          String    @map("user_id") @db.Uuid
  metaUserId      String    @map("meta_user_id") // Facebook user ID
  adAccountId     String    @map("ad_account_id") // act_XXXXX format
  adAccountName   String?   @map("ad_account_name")
  accessToken     String    @map("access_token") // Long-lived access token
  tokenExpiresAt  DateTime? @map("token_expires_at")
  currency        String    @default("USD")
  timezone        String    @default("America/New_York")
  status          String    @default("active") // active | paused | disconnected
  lastSyncedAt    DateTime? @map("last_synced_at")
  metadata        Json?     @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  campaigns MetaCampaign[]
  insights  MetaInsight[]

  @@unique([userId, adAccountId])
  @@index([userId, status])
  @@map("meta_ad_accounts")
}

// Synced Meta Campaigns
model MetaCampaign {
  id              String         @id @default(cuid())
  adAccountId     String         @map("ad_account_id")
  adAccount       MetaAdAccount  @relation(fields: [adAccountId], references: [id], onDelete: Cascade)
  metaCampaignId  String         @map("meta_campaign_id") // Meta's campaign ID
  name            String
  objective       String?        // AWARENESS, TRAFFIC, ENGAGEMENT, LEADS, etc.
  status          String         @default("PAUSED") // ACTIVE, PAUSED, DELETED, ARCHIVED
  effectiveStatus String?        @map("effective_status") // Computed status from Meta
  dailyBudget     Float?         @map("daily_budget") // In cents
  lifetimeBudget  Float?         @map("lifetime_budget") // In cents
  startTime       DateTime?      @map("start_time")
  stopTime        DateTime?      @map("stop_time")
  
  // Aggregated metrics (updated on sync)
  impressions     Int            @default(0)
  clicks          Int            @default(0)
  spend           Float          @default(0) // Total spend
  reach           Int            @default(0)
  conversions     Int            @default(0)
  
  metadata        Json?          @default("{}")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  adSets   MetaAdSet[]
  insights MetaInsight[]

  @@unique([adAccountId, metaCampaignId])
  @@index([adAccountId, status])
  @@map("meta_campaigns")
}

// Synced Meta Ad Sets
model MetaAdSet {
  id              String        @id @default(cuid())
  campaignId      String        @map("campaign_id")
  campaign        MetaCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  metaAdSetId     String        @map("meta_ad_set_id") // Meta's ad set ID
  name            String
  status          String        @default("PAUSED")
  effectiveStatus String?       @map("effective_status")
  dailyBudget     Float?        @map("daily_budget")
  lifetimeBudget  Float?        @map("lifetime_budget")
  targetingJson   Json?         @map("targeting_json") // Targeting specification
  
  // Aggregated metrics
  impressions     Int           @default(0)
  clicks          Int           @default(0)
  spend           Float         @default(0)
  reach           Int           @default(0)
  conversions     Int           @default(0)
  
  metadata        Json?         @default("{}")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  ads      MetaAd[]
  insights MetaInsight[]

  @@unique([campaignId, metaAdSetId])
  @@index([campaignId, status])
  @@map("meta_ad_sets")
}

// Synced Meta Ads
model MetaAd {
  id              String      @id @default(cuid())
  adSetId         String      @map("ad_set_id")
  adSet           MetaAdSet   @relation(fields: [adSetId], references: [id], onDelete: Cascade)
  metaAdId        String      @map("meta_ad_id") // Meta's ad ID
  name            String
  status          String      @default("PAUSED")
  effectiveStatus String?     @map("effective_status")
  creativeId      String?     @map("creative_id") // Meta creative ID
  previewUrl      String?     @map("preview_url")
  
  // Aggregated metrics
  impressions     Int         @default(0)
  clicks          Int         @default(0)
  spend           Float       @default(0)
  reach           Int         @default(0)
  conversions     Int         @default(0)
  
  metadata        Json?       @default("{}")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  insights MetaInsight[]

  @@unique([adSetId, metaAdId])
  @@index([adSetId, status])
  @@map("meta_ads")
}

// Meta Insights (Performance Data)
model MetaInsight {
  id            String         @id @default(cuid())
  adAccountId   String         @map("ad_account_id")
  adAccount     MetaAdAccount  @relation(fields: [adAccountId], references: [id], onDelete: Cascade)
  campaignId    String?        @map("campaign_id")
  campaign      MetaCampaign?  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  adSetId       String?        @map("ad_set_id")
  adSet         MetaAdSet?     @relation(fields: [adSetId], references: [id], onDelete: Cascade)
  adId          String?        @map("ad_id")
  ad            MetaAd?        @relation(fields: [adId], references: [id], onDelete: Cascade)
  
  date          DateTime       // Date of the insight data
  level         String         // account, campaign, adset, ad
  
  // Core metrics
  impressions   Int            @default(0)
  clicks        Int            @default(0)
  spend         Float          @default(0)
  reach         Int            @default(0)
  frequency     Float          @default(0)
  
  // Engagement metrics
  ctr           Float          @default(0) // Click-through rate
  cpc           Float          @default(0) // Cost per click
  cpm           Float          @default(0) // Cost per 1000 impressions
  
  // Conversion metrics
  conversions   Int            @default(0)
  costPerResult Float          @default(0) @map("cost_per_result")
  
  // Additional breakdown data
  actionsJson   Json?          @map("actions_json") // Detailed action breakdown
  
  createdAt     DateTime       @default(now()) @map("created_at")

  @@unique([adAccountId, campaignId, adSetId, adId, date, level])
  @@index([adAccountId, date])
  @@index([campaignId, date])
  @@map("meta_insights")
}

// ============================================================================
// TWILIO SMS - Phone verification, messaging, and conversation memory
// ============================================================================

model UserPhone {
  id                      String   @id @default(cuid())
  profileId               String   @unique @map("profile_id") @db.Uuid
  profile                 Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  phoneNumber             String   @unique @map("phone_number") // E.164 format
  verified                Boolean  @default(false)
  autopilotEnabled        Boolean  @default(false) @map("autopilot_enabled")
  digestEnabled           Boolean  @default(true)  @map("digest_enabled")
  overdueRemindersEnabled Boolean  @default(true)  @map("overdue_reminders_enabled")
  referralAlertsEnabled   Boolean  @default(true)  @map("referral_alerts_enabled")
  digestTime              String   @default("18:00") @map("digest_time") // HH:mm format
  quietStart              String?  @map("quiet_start") // HH:mm format
  quietEnd                String?  @map("quiet_end")   // HH:mm format
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@index([phoneNumber])
  @@map("user_phones")
}

model SMSMessage {
  id        String   @id @default(cuid())
  profileId String   @map("profile_id") @db.Uuid
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  direction String   // inbound | outbound
  from      String
  to        String
  body      String
  twilioSid String   @unique @map("twilio_sid")
  status    String   @default("sent") // sent | delivered | failed
  lamRunId  String?  @map("lam_run_id")
  lamRun    LamRun?  @relation(fields: [lamRunId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([profileId, createdAt(sort: Desc)])
  @@index([twilioSid])
  @@map("sms_messages")
}

model Conversation {
  id           String    @id @default(cuid())
  profileId    String    @map("profile_id") @db.Uuid
  profile      Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  channel      String    // sms | web | whatsapp
  lastActiveAt DateTime  @default(now()) @map("last_active_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  messages ConversationMessage[]

  @@index([profileId, lastActiveAt(sort: Desc)])
  @@map("conversations")
}

model ConversationMessage {
  id        String   @id @default(cuid())
  convId    String   @map("conv_id")
  conv      Conversation @relation(fields: [convId], references: [id], onDelete: Cascade)
  role      String   // user | assistant | system
  content   String
  channel   String   // sms | web | whatsapp
  lamRunId  String?  @map("lam_run_id")
  lamRun    LamRun?  @relation(fields: [lamRunId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([convId, createdAt(sort: Asc)])
  @@map("conversation_messages")
}
